<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Simplified Trading Bot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="trading_theme.css">
</head>
<body class="text-gray-200 body">
    <div class="container mx-auto max-w-4xl p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-white">Simplified Trading Bot</h1>
            <p class="text-gray-400 mt-2">A minimal interface for Binance Futures Testnet (USDT-M)</p>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col space-y-6">
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-white">Place New Order</h2>
                    <div id="order-form" class="space-y-4">
                        <div class="grid grid-cols-2 gap-3">
                            <button id="btn-buy" class="side-btn bg-green-600/20 text-green-400 border border-green-500/50 w-full py-2 rounded-md font-semibold transition hover:bg-green-500 hover:text-white">BUY</button>
                            <button id="btn-sell" class="side-btn bg-gray-700 w-full py-2 rounded-md font-semibold transition hover:bg-red-500 hover:text-white">SELL</button>
                        </div>
                        
                        <!-- Symbol -->
                        <div>
                            <label for="symbol" class="block text-sm font-medium text-gray-400 mb-1">Symbol</label>
                            <input type="text" id="symbol" value="BTCUSDT" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>

                        <!-- Order Type -->
                        <div class="grid grid-cols-3 gap-2">
                             <button id="btn-market" class="type-btn border w-full py-2 rounded-md font-semibold transition hover:bg-blue-500 hover:text-white text-sm">MARKET</button>
                             <button id="btn-limit" class="type-btn border w-full py-2 rounded-md font-semibold transition hover:bg-blue-500 hover:text-white text-sm">LIMIT</button>
                             <button id="btn-stop-limit" class="type-btn border w-full py-2 rounded-md font-semibold transition hover:bg-blue-500 hover:text-white text-sm">STOP-LIMIT</button>
                        </div>
                        
                        <!-- Quantity -->
                        <div>
                            <label for="quantity" class="block text-sm font-medium text-gray-400 mb-1">Quantity</label>
                            <input type="number" id="quantity" placeholder="0.001" step="0.001" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>

                        <!-- Stop Price (for Stop-Limit orders) -->
                        <div id="stop-price-container" class="hidden">
                            <label for="stop-price" class="block text-sm font-medium text-gray-400 mb-1">Stop Price (USDT)</label>
                            <input type="number" id="stop-price" placeholder="61000" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>
                        
                        <!-- Price (for Limit and Stop-Limit orders) -->
                        <div id="price-container" class="hidden">
                            <label for="price" class="block text-sm font-medium text-gray-400 mb-1">Limit Price (USDT)</label>
                            <input type="number" id="price" placeholder="60000" class="w-full bg-gray-700 border border-gray-600 rounded-md px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
                        </div>

                        <!-- Submit Button -->
                        <button id="place-order-btn" class="w-full bg-blue-600 text-white font-bold py-3 rounded-md transition hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-800 focus:ring-blue-500 disabled:bg-gray-500 disabled:cursor-not-allowed flex items-center justify-center">
                            <span id="btn-text">Place Order</span>
                            <svg id="btn-loader" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-gray-800 p-6 rounded-lg shadow-lg flex flex-col">
                
                <!-- Order Status -->
                <div>
                    <h2 class="text-lg font-semibold mb-3 text-white">Order Status</h2>
                    <div id="order-status" class="bg-gray-900 rounded-md p-4 min-h-[80px] text-gray-400 text-sm flex items-center justify-center">
                        Awaiting new order...
                    </div>
                </div>

                <!-- Logs -->
                <div class="mt-6 flex-grow flex flex-col">
                    <div class="flex justify-between items-center mb-3">
                        <h2 class="text-lg font-semibold text-white">Logs</h2>
                        <button id="clear-logs-btn" class="text-xs text-gray-400 hover:text-white transition">Clear</button>
                    </div>
                    <div id="log-panel" class="log-panel bg-gray-900 rounded-md p-4 flex-grow h-64 overflow-y-auto font-mono text-xs">
                        <!-- Log messages will be appended here -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer class="text-center mt-8 text-gray-500 text-sm">
            <p>Â© All rights reserved  by Tejas D.</p>
        </footer>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let orderSide = 'BUY';
            let orderType = 'MARKET';
            let isSubmitting = false;

            // --- ELEMENTS ---
            const btnBuy = document.getElementById('btn-buy');
            const btnSell = document.getElementById('btn-sell');
            const btnMarket = document.getElementById('btn-market');
            const btnLimit = document.getElementById('btn-limit');
            const btnStopLimit = document.getElementById('btn-stop-limit');
            
            const priceContainer = document.getElementById('price-container');
            const stopPriceContainer = document.getElementById('stop-price-container');
            const placeOrderBtn = document.getElementById('place-order-btn');
            const btnText = document.getElementById('btn-text');
            const btnLoader = document.getElementById('btn-loader');
            
            const symbolInput = document.getElementById('symbol');
            const quantityInput = document.getElementById('quantity');
            const priceInput = document.getElementById('price');
            const stopPriceInput = document.getElementById('stop-price');
            
            const orderStatus = document.getElementById('order-status');
            const logPanel = document.getElementById('log-panel');
            const clearLogsBtn = document.getElementById('clear-logs-btn');

            // --- FUNCTIONS ---
            
            const log = (type, message, data = null) => {
                const timestamp = new Date().toLocaleTimeString();
                const entry = document.createElement('div');
                let colorClass = '';
                let typeText = '';

                switch(type) {
                    case 'request':
                        colorClass = 'text-cyan-400';
                        typeText = '[REQUEST]';
                        break;
                    case 'response':
                        colorClass = 'text-green-400';
                        typeText = '[RESPONSE]';
                        break;
                    case 'error':
                        colorClass = 'text-red-400';
                        typeText = '[ERROR]';
                        break;
                    default:
                        colorClass = 'text-gray-400';
                        typeText = '[INFO]';
                }

                let logMessage = `<span class="text-gray-500">${timestamp}</span> <span class="${colorClass} font-bold">${typeText}</span> ${message}`;
                if (data) {
                    logMessage += `<br><pre class="text-gray-500 pl-4 whitespace-pre-wrap">${JSON.stringify(data, null, 2)}</pre>`;
                }
                
                entry.innerHTML = logMessage;
                entry.classList.add('mb-2');
                
                logPanel.prepend(entry);
            };

            const updateSideButtons = () => {
                if (orderSide === 'BUY') {
                    btnBuy.className = 'side-btn bg-green-600/20 text-green-400 border border-green-500/50 w-full py-2 rounded-md font-semibold transition hover:bg-green-500 hover:text-white';
                    btnSell.className = 'side-btn bg-gray-700 w-full py-2 rounded-md font-semibold transition hover:bg-red-500 hover:text-white';
                } else {
                    btnSell.className = 'side-btn bg-red-600/20 text-red-400 border border-red-500/50 w-full py-2 rounded-md font-semibold transition hover:bg-red-500 hover:text-white';
                    btnBuy.className = 'side-btn bg-gray-700 w-full py-2 rounded-md font-semibold transition hover:bg-green-500 hover:text-white';
                }
            };

            const updateTypeButtons = () => {
                priceContainer.style.display = (orderType === 'LIMIT' || orderType === 'STOP_LIMIT') ? 'block' : 'none';
                stopPriceContainer.style.display = orderType === 'STOP_LIMIT' ? 'block' : 'none';

                btnMarket.classList.toggle('type-btn-active', orderType === 'MARKET');
                btnMarket.classList.toggle('type-btn-inactive', orderType !== 'MARKET');
                
                btnLimit.classList.toggle('type-btn-active', orderType === 'LIMIT');
                btnLimit.classList.toggle('type-btn-inactive', orderType !== 'LIMIT');
                
                btnStopLimit.classList.toggle('type-btn-active', orderType === 'STOP_LIMIT');
                btnStopLimit.classList.toggle('type-btn-inactive', orderType !== 'STOP_LIMIT');
            };
            
            const setLoadingState = (loading) => {
                isSubmitting = loading;
                placeOrderBtn.disabled = loading;
                btnText.style.display = loading ? 'none' : 'inline';
                btnLoader.style.display = loading ? 'inline' : 'none';
            };
            
            const showStatus = (type, message) => {
                let colorClass = '';
                switch(type) {
                    case 'success':
                        colorClass = 'bg-green-900/50 text-green-300';
                        break;
                    case 'error':
                        colorClass = 'bg-red-900/50 text-red-300';
                        break;
                    default:
                        colorClass = 'bg-gray-700 text-gray-400';
                }
                orderStatus.className = `rounded-md p-4 min-h-[80px] text-sm flex items-center justify-center transition-all ${colorClass}`;
                orderStatus.textContent = message;
            };

            const handlePlaceOrder = async () => {
                if (isSubmitting) return;

                // --- Frontend Validation ---
                const symbol = symbolInput.value;
                const quantity = parseFloat(quantityInput.value);
                const price = parseFloat(priceInput.value);
                const stopPrice = parseFloat(stopPriceInput.value);

                if (!symbol) {
                    showStatus('error', 'Symbol is required.');
                    log('error', 'Validation failed: Symbol is missing.');
                    return;
                }
                if (isNaN(quantity) || quantity <= 0) {
                    showStatus('error', 'A valid positive quantity is required.');
                    log('error', 'Validation failed: Invalid quantity.');
                    return;
                }
                if ((orderType === 'LIMIT' || orderType === 'STOP_LIMIT') && (isNaN(price) || price <= 0)) {
                    showStatus('error', 'A valid positive limit price is required.');
                    log('error', 'Validation failed: Invalid limit price.');
                    return;
                }
                if (orderType === 'STOP_LIMIT' && (isNaN(stopPrice) || stopPrice <= 0)) {
                    showStatus('error', 'A valid positive stop price is required for STOP_LIMIT orders.');
                    log('error', 'Validation failed: Invalid stop price.');
                    return;
                }
                
                // --- API Call ---
                setLoadingState(true);
                showStatus('info', 'Submitting order to backend...');
                
                const orderData = {
                    symbol,
                    side: orderSide,
                    type: orderType,
                    quantity,
                };
                if (orderType === 'LIMIT') {
                    orderData.price = price;
                } else if (orderType === 'STOP_LIMIT') {
                    orderData.price = price;
                    orderData.stopPrice = stopPrice;
                }
                
                log('request', `Sending order to backend:`, orderData);
                
                try {
                    const response = await fetch('http://127.0.0.1:5000/place_order', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderData),
                    });

                    const result = await response.json();

                    if (!response.ok) {
                        log('error', `API call failed: ${result.message || 'Unknown server error'}`, result);
                        showStatus('error', `Failed to place order: ${result.message || 'Server error'}`);
                    } else {
                        log('response', `Order successfully processed by backend.`, result);
                        showStatus('success', `Placed ${result.side} ${result.type} for ${result.origQty} ${result.symbol}. Status: ${result.status}`);
                    }
                } catch (error) {
                    const errorMessage = 'Could not connect to the backend server. Is it running?';
                    log('error', errorMessage, { error: error.message });
                    showStatus('error', errorMessage);
                } finally {
                    setLoadingState(false);
                }
            };

            // --- EVENT LISTENERS ---
            btnBuy.addEventListener('click', () => {
                orderSide = 'BUY';
                updateSideButtons();
            });

            btnSell.addEventListener('click', () => {
                orderSide = 'SELL';
                updateSideButtons();
            });

            btnMarket.addEventListener('click', () => {
                orderType = 'MARKET';
                updateTypeButtons();
            });

            btnLimit.addEventListener('click', () => {
                orderType = 'LIMIT';
                updateTypeButtons();
            });

            btnStopLimit.addEventListener('click', () => {
                orderType = 'STOP_LIMIT';
                updateTypeButtons();
            });
            
            placeOrderBtn.addEventListener('click', handlePlaceOrder);
            
            clearLogsBtn.addEventListener('click', () => {
                logPanel.innerHTML = '';
            });

            // --- INITIALIZATION ---
            log('info', 'Trading Bot UI Initialized.');
            updateSideButtons();
            updateTypeButtons();
        });
    </script>

</body>
</html>

